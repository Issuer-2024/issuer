<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webpage Layout</title>
    <link rel="icon" href="../static/favicon.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/progressbar.js@1.0.1/dist/progressbar.min.js"></script>
</head>
<body class="bg-gray-100">
    {% include "header.html" %}
    <div class="flex gap-10" style="margin: 1rem 15% 0 15%">
        <div>
            <div class="flex flex-col gap-6 bg-white rounded p-6" style="border: 1px solid #ccc">
                <div class="flex flex-col">
                    <span style="font-size: 2.25rem; font-weight: 700; height: 1;">
                        {{ keyword }}
                    </span>
                    <span style="font-size:0.9rem; color: dimgray">ë¬¸ì„œ ìƒì„± ì‹œê°:
                        {{ created_at }}
                    </span>
                </div>
                <div class="flex flex-col gap-4 items-center justify-center">
                    <span class="m-5" style="font-size: 2.25rem; font-weight: 500; height: 1;">
                        ìƒì„± ì¤‘ì¸ ë¬¸ì„œì…ë‹ˆë‹¤. ë‚˜ì¤‘ì— ë“¤ì–´ì˜¤ì‹œë©´ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”ğŸ¥º
                    </span>
                    <div id="creating-progress-container" class="rounded-lg" style="width: 70%"></div>
                    <span id="creating-status" class="text-gray-500">{{ status }}</span>

                    <div class="flex gap-3">
                        <div>
                            {% include "keyword_rank.html" %}
                        </div>
                        <div>
                            {% include "recently_added_list.html" %}
                        </div>
                        <div>
                            {% include "creating_list.html" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</body>
<script>
    window.onload = () => {
        fetchChanges();
        fetchCreating();
        setInterval(fetchChanges, 15000)
        setInterval(fetchCreating, 15000)
    }

    document.addEventListener('DOMContentLoaded', function () {
        var container = document.getElementById('creating-progress-container');

        // Line íƒ€ì…ì˜ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìƒì„±
        var bar = new ProgressBar.Line(container, {
            strokeWidth: 2,
            color: '#000',
            trailColor: '#eee',
            trailWidth: 1,
            easing: 'easeInOut',
            duration: 3000,  // ì• ë‹ˆë©”ì´ì…˜ì„ ë¹„í™œì„±í™”í•˜ë ¤ë©´ 0ìœ¼ë¡œ ì„¤ì •
            svgStyle: {width: '100%', height: '100%'},
            from: {color: '#FFEA82'},
            to: {color: '#ED6A5A'},
            step: (state, line) => {
                line.path.setAttribute('stroke', state.color);
                var value = Math.round(line.value() * 100);
                if (value === 0) {
                    line.setText('');
                } else {
                    line.setText(value + '%');
                }
            }
        });

        bar.animate({{ ratio / 100 }}); // ì´ˆê¸° ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •

        // SSE ì—°ê²°
        var eventSource = new EventSource('/stream');

        eventSource.onmessage = function (event) {
            var data = JSON.parse(event.data);
            var target = "{{ keyword }}";  // í˜„ì¬ targetì„ 'q'ë¡œ ì„¤ì • (ì‹¤ì œ ë¡œì§ì—ì„œëŠ” ë™ì ìœ¼ë¡œ ì„¤ì • ê°€ëŠ¥)

            if (data.target === target) {
                bar.animate(data.ratio / 100);  // í”„ë¡œê·¸ë ˆìŠ¤ ë°”ì˜ ë¹„ìœ¨ ì„¤ì •
                document.getElementById('creating-status').innerText = data.message

                // ë©”ì‹œì§€ì™€ ê´€ë ¨ëœ ì¶”ê°€ UI ì—…ë°ì´íŠ¸ ë¡œì§ì„ ì—¬ê¸°ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

                if (data.ratio === 100) {
                    setTimeout(function () {
                        location.reload();  // ì™„ë£Œ í›„ 3ì´ˆ ë’¤ ìƒˆë¡œê³ ì¹¨
                    }, 3000);
                }
            }
        };

        eventSource.onerror = function () {
            console.error('SSE connection error');
        };

         window.addEventListener('beforeunload', function () {
            eventSource.close();
            console.log('SSE connection closed');
        });
    });
</script>
</html>
